name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-backend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Generate Prisma Client
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
        run: npx prisma generate
      
      - name: TypeScript type check
        working-directory: ./backend
        run: npx tsc --noEmit
      
      - name: Build backend
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: backend-dist
          path: backend/dist/
          retention-days: 7

  build-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_BASE_URL: https://api.example.com/api
        run: npm run build
      
      - name: Check bundle size
        working-directory: ./frontend
        run: |
          if [ -d "dist" ]; then
            SIZE=$(du -sb dist | cut -f1)
            SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
            echo "üì¶ Bundle size: ${SIZE_MB}MB"
            
            # Warn if bundle is larger than 5MB
            if [ $SIZE -gt 5242880 ]; then
              echo "‚ö†Ô∏è Warning: Bundle size (${SIZE_MB}MB) exceeds 5MB"
              echo "Consider code splitting or optimizing assets"
            else
              echo "‚úÖ Bundle size is within acceptable limits"
            fi
          else
            echo "‚ùå dist directory not found"
            exit 1
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 7
